Attribute VB_Name = "ADSKPartnerCenterPass"
'----------------------------------------------------------------------------
' Модуль ADSKPartnerCenterPass - работа с License Inquiry PartnerCenter.Autodesk.com
'
''' суть этой процедуры в головной программе SN3PASS:
''' 1)                - очищаем лист 3PASS
''' 2) SNselection    - готовим список SN из листа ADSKfrSF
''' 3)   **           - из списка на листе 3PASS переносим (Copy/Paste) SN
'''                     порциями на портал ADSK в Tab <License Inquiry>, затем <Go>
'''                     эту подпрограмму запускаем по кнопке [2] многократно
'''                     до исчерпания списка SN в А2 - начало порции, в А3 - конец
''' 4) Load3passSN    - считываем на лист 3PASS выходные файлы из Autodesk
''' 5) DoDeDupSN      - дедупликация серийных номеров на листе 3PASS
''' 6) WrDL3pass      - запись из таблицы 3PASS в файл CSV для Data Loader
'
'   8.2.2012
'  16.8.2013 - переписано для match 2.0

    Option Explicit     ' Force explicit variable declaration
    
    
Sub SN_PC_pass()
'
' S SN_PC_Pass - получение серийных номеров (SN) из PartnerCenter.Autodesk.com
'                по списку в SN_LIST по порциям, а затем сортировка этих данных
'                на SN_ACTIVE и SN_UPDATE.
'
'   16.8.2013

    Const SN_LIST = "A_SN_1"
    Const SN_TMP = "A_SN_2"
    Const SN_UPDATE = "A_SN_3"
    
    Const HelpStage = " скопированы в буфер клипборд." & vbCrLf & _
        vbCrLf & "Теперь:" & _
        vbCrLf & "1. в окне Serial Number <License Inquiry>" & _
        vbCrLf & "   PartnerCenter.Autodesk.com нажми Ctrl/V, затем [Go]" & _
        vbCrLf & "2. в Menu -> Export -> Next получи файлы output.csv." & _
        vbCrLf & _
        vbCrLf & "После появления output.csv в каталоге <Загрузки> жми [OK]."
                        
    Const SNstep = 100  ' максимальная порция SN
    
    Dim R As TOCmatch
    Dim i As Long, ToN As Long  ' номера строк
    
    StepIn
    R = GetRep(SN_LIST)
    MS "Проверяем в PartnerCenter.Autodesk.com " & R.EOL & " строк Registered SN"
    
 '---------- инициализация рабочих листов и глобальных данных -------------
''    iActive = 1: iUpdate = 1
''    nActive = 0: nUpdate = 0: nToClean = 0
''
''    Dim Ractive As TOCmatch, Rupdate As TOCmatch
''
''    Ractive = GetRep(ST_ACTIVE)
''    Rupdate = GetRep(ST_UPDATE)
''    NewSheet Ractive.Name
''    NewSheet Rupdate.Name
    NewSheet SN_UPDATE
    
  '--------------- цикл порциями по SN_List ---------------
    i = 2
    With Workbooks(R.RepFile).Sheets(R.SheetN)
        Do While i <= R.EOL
            .Activate
            ToN = i + SNstep
            If ToN > R.EOL Then ToN = R.EOL
            .Cells(ToN, 1) = Left(.Cells(ToN, 1), 12)   ' убираем последний +
            Range(.Cells(i, 1), .Cells(ToN, 1)).Select  ' выбираем порцию
            Selection.Copy
            Selection.Interior.Color = rgbYellow        ' окрашиваем порцию желтым
            
            On Error Resume Next
            Kill DownloadDir & "output*.csv"    ' Очищаем все старые файлы output*.csv
            On Error GoTo 0                     ' на случай, когда output*.csv отсутствует
            
            MsgBox "SN от " & i & " до " & ToN & HelpStage
            SNread SN_TMP
            SNupdate SN_TMP, SN_UPDATE
            i = i + SNstep
        Loop
    End With
End Sub
Sub SNread(F As String)
'
' - SNread  - функция чтения файла серийных номеров из Output.CSV
'             в верхний левый угол листа F
'   31/1/2012
'   13.08.13 - упрощен интерфейс - чтение всегда в A_SN_2
'   16.08.13 - сортировка прочитанного файла по SN

    Dim R As TOCmatch

    NewSheet F      ' Сбрасываем файл SN из PartnerCenter
    
    R = GetRep(F)
    If R.EOL <> 1 Then ErrMsg FATAL_ERR, "Лист \\W_TMP.A_PC_2' не очищен!"
    Workbooks(R.RepFile).Sheets(R.SheetN).Activate
    
    With ActiveSheet.QueryTables.Add( _
            Connection:="TEXT;" & DownloadDir & "output.csv", _
            Destination:=Cells(2, 1))
        .Name = "output"
        .FieldNames = True
        .RowNumbers = False
        .FillAdjacentFormulas = False
        .PreserveFormatting = True
        .RefreshOnFileOpen = False
        .RefreshStyle = xlInsertDeleteCells
        .SavePassword = False
        .SaveData = True
        .AdjustColumnWidth = True
        .RefreshPeriod = 0
        .TextFilePromptOnRefresh = False
        .TextFilePlatform = 1252
        .TextFileStartRow = 1
        .TextFileParseType = xlDelimited
        .TextFileTextQualifier = xlTextQualifierDoubleQuote
        .TextFileConsecutiveDelimiter = False
        .TextFileTabDelimiter = True
        .TextFileSemicolonDelimiter = False
        .TextFileCommaDelimiter = False
        .TextFileSpaceDelimiter = False
        .TextFileColumnDataTypes = _
            Array(2, 2, 2, 2, 2, 2, 2, 2, 3, 2, 2, 2, 2, 2, 2, 2)
        .TextFileTrailingMinusNumbers = True
        On Error GoTo Rep
        .Refresh BackgroundQuery:=False
        On Error GoTo 0
     End With
   
    ActiveSheet.Rows(2).Delete
    ActiveSheet.Columns(SNTMP_ACTDATE_COL).Select
    Selection.NumberFormat = "d/mm/yyyy;@"
    Call SheetSort(R.Name, 1)
    R.EOL = EOL(R.SheetN)
'----- дедупликация -----------------
'
' Действие  : =SN :i=R:i-1=Registered
'    NOP    :  0  : - : - :
' Del i-1 Rw:  1  : 0 : 0 : Upgraded -> Upgraded     \ Оставляем строку
' Del i-1 Rw:  1  : 0 : 1 : Upgraded -> Registered    |   со статусом
' Del i Row :  1  : 1 : 0 : Registered -> Upgraded    |   Registered
' Del i-1 Rw:  1  : 1 : 1 : Registered -> Registered /  или последнюю

    Dim i As Long, SN As String, Status As String
    SN = "": Status = "": i = 2
    With ActiveSheet
        Do
            If .Cells(i, SNTMP_SN_COL) = SN Then
                If .Cells(i, SNTMP_STATUS_COL) <> SNTMP_STATUS_REGISTERED And _
                                         Status = SNTMP_STATUS_REGISTERED _
                Then
                    .Rows(i).Delete
                Else
                    .Rows(i - 1).Delete
                End If
                R.EOL = R.EOL - 1
                i = i - 1
            End If
            SN = .Cells(i, SNTMP_SN_COL)
            Status = .Cells(i, SNTMP_STATUS_COL)
            i = i + 1
        Loop While i <= R.EOL
    End With

    R.Dat = Now
    R.Made = "SNread"
    R.CreateDat = Now
    RepTOC = R: Call WrTOC(R.Name)
    Exit Sub
Rep:
    If MsgBox("В каталоге 'Загрузки' не найден файл 'output.csv'." _
        & vbCrLf & "'" & DownloadDir & "output.csv" & "'" _
        & vbCrLf & vbCrLf & "Убедись, что он загружен из PartnerCenter и повтори.") _
        = vbYes Then
            Call SNread(F)
    Else
            End
    End If
End Sub
Sub SNupdate(FrF As String, ToF As String)
'
' - SNupdate(FrF, ToF)   - перенос порции данных из листа FrF
'                          в лист ToF в конец листа ToF (Append)
' 16.6.13

    Dim Rfr As TOCmatch, Rto As TOCmatch
    
    Rfr = GetRep(FrF)
    Rto = GetRep(ToF)
    
    Workbooks(Rfr.RepFile).Sheets(Rfr.SheetN).Activate
    ActiveSheet.Rows("2:" & Rfr.EOL).Copy _
        Destination:=Workbooks(Rto.RepFile).Sheets(Rto.SheetN).Cells(Rto.EOL + 1, 1)
    
    Rto.Dat = Now
    Rto.Made = "SNupdate"
    Rto.CreateDat = Now
    Rto.EOL = EOL(Rto.SheetN)
    RepTOC = Rto: Call WrTOC(Rto.Name)
End Sub

'''Function SNcheck(ByVal SN As String, SNtmp) As String
''''
'''' - SNcheck(SN, SNtmp) - cверка статуса SN в SN_TMP и SF. Возвращает
''''       - Active    - SN в Активах и все данные правильные
''''       - InsAct    - Новый SN - вставить в Активы SF
''''       - Update    - изменить данные в SF, например, Upgrade
''''
'''' 15.8.13
'''
'''    Dim i
'''    Dim R As TOCmatch
'''
'''    R = GetRep(SNtmp)
'''
'''    SNcheck = "Active"
'''
'''    With Workbooks(R.RepFile).Sheets(R.SheetN)
'''        For i = 2 To R.EOL
'''            If SN = .Cells(i, 1) Then GoTo SNfound
'''        Next i
'''        SNcheck = "Not Found"
'''        Exit Function
'''SNfound:
'''        Select Case ActiveSNchk(SN, SNtmp)
'''        Case "OK":
'''        Case "ActiveSNupd":
'''        Case Else
'''        End Select
'''
'''        If .Cells(i, 1) = .Cells(i + 1, 1) Then
'''            Stop    ' не дописано - случай если в SNtmp несколько строк по SN!!!
'''        End If
'''
'''        If .Cells(i, SN_PC_STAT_COL) = "Registered" Then
'''        End If
'''    End With
'''End Function
'''
'''Sub SNsortOut(SN, SNtmp, SNactive, SNupdate)
''''
'''' - SNsortOut(SNtmp, SNactive, SNupdate) - разбор и селекция SN из SNtmp.
''''      - в SNactive заносятся данные о Registered SN
''''      - в SNudpade - об Upgraded SN, которые надо изменить в SF
''''   Кроме того в SN_LIST изменяется цвет SN:
''''           - белый      - SN найден, он Registered
''''           - коричневый - найден, требуется Update
''''           - остается желтый - не найден или требует ручной проверки
''''
''''   13.8.2013
'''
'''    Dim iTmp As Long    '- указатель - номер строки в SNtmp
'''
'''    For iTmp = 2 To Rtmp.EOL
'''        SN =
'''    Next iTmp
'''End Sub
'''
'''Sub LoadSNfrOutputCSV()
''''
'''' [3] - чтение SN полученных из Licence Inquiry в файлов output.csv
'''' Файлов может быть несколько. После обработки они стираются.
''''
''''   1.2.2012
'''
'''    Const CSVstamp1 = "Serial Number"
'''    Const CSVstamp2 = "Product Key"
'''    Dim F, SN, Status As String
'''    Dim R, C, i, j As Integer
'''
'''    Start3PASS ("Загрузка файлов output*.csv")
'''
'''' запись списка файлов output*.csv в колонку B листа 3PASS
'''    F = dir(DownloadDir & "output*.csv")
'''    i = 2
'''    Do While F <> ""
'''        Cells(i, 2) = DownloadDir & F
'''        Cells(i, 2).Select
'''        F = dir()
'''        i = i + 1
'''    Loop
'''
'''' чтение файлов по списку в В
'''    R = 5: i = 2: C = 7
'''    Do While Cells(i, 2) <> ""
'''        Cells(i, 2).Select
'''        Call SNread(Cells(i, 2), R, C)    ' чтение файла output.csv
'''    ' проверка, правильный ли файл прочитали?
'''        If Cells(R, C) <> CSVstamp1 Or Cells(R, C + 1) <> CSVstamp2 Then
'''            MsgBox "Неправильный входной файл (" & F & _
'''                ") в листе 3PASS, начиная с ячейки (" _
'''                & R & "," & C & ")", vbCritical, "ERROR!"
'''            Stop
'''        End If
'''    ' удаление шапки прочитанного файла
'''        Range("G" & R & ":V" & R).Delete Shift:=xlUp
'''        While Cells(R, C) <> "" ' продвигаем R до нижней строки
'''            R = R + 1
'''        Wend
'''        i = i + 1
'''    Loop
'''
'''    ' проверяем, все ли SN из списка в колонке А нашлись?
'''    R = R - 1
'''    i = 5
'''    Do
'''        SN = Left(Cells(i, 1), 12)        ' желтый SN
''''        Cells(i, 1).Select
'''        For j = 2 To R
'''            If SN = "" Then Exit Do
'''            If SN = Cells(j, 7) Then
'''                i = i + 1
'''                Exit For
'''            End If
'''        Next j
'''    Loop
'''
'''    If i - 1 <> Cells(3, 1) Then
'''        MsgBox "Не все серийные номера нашлись -- см.лист 3PASS", , "ERROR!"
'''        Stop
'''    End If
'''
'''    Range("B5:B" & i).ClearContents
'''    Range("A4:A" & Cells(3, 1)).ClearContents
'''    Range("B4:F" & R).FillDown  ' копируем формулы до конца (R)
'''
'''    End3PASS 3
'''End Sub
'''Sub DoDeDupSN()
''''
'''' [*] Дедупликация серийных номеров на листе 3PASS
''''   6.2.2012
'''
'''End Sub
'''Sub WrDL3pass()
''''
'''' [3PASS] - запись при помощи Data Loader'a листа 3PASS в Salesforce
''''   3/2/2012
'''
'''    Start3PASS "Запись листа 3PASS посредством DataLoader в SF"
'''
'''    Columns("C:C").Copy
'''    Columns("O:O").PasteSpecial Paste:=xlPasteValues
''''    Columns("O:O").Select
''''    Selection.PasteSpecial Paste:=xlPasteValues
'''
'''    ChDir "C:\Users\Пользователь\Desktop\Работа с Match\SFconstrTMP\ADSK\3PASS\"
'''    WriteCSV A3PASS, "3PASS.txt", 1, 7
'''
'''    Shell "quota_3PASS.bat"
''''    Shell "Copy 3PASS.csv C:\SFconstr"
'''
'''    End3PASS (4)
'''End Sub
